<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.0/d3.min.js" integrity="sha512-jXsLjbg/Pr8F5U2evjFaEci7mImlUix865lbvnNmp5TzS86+VTTFVDz7FFTS6VHdhSn7UJ4tjZdvpp0GgT0fZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script>

<script type="module">
  import { Application, Controller } from "https://unpkg.com/@hotwired/stimulus/dist/stimulus.js"

  window.Stimulus = Application.start()

  var svg;
  var firstBox;
  var secondBox;
  var gameBackground;
  var flags;
  var playerIcon;


  Stimulus.register("survival-game", class extends Controller {
    static values = {
      url: String,
      width: Number,
      firstBox: Object,
      secondBox: Object,
      startText: String,
      playerIconUrl: String,
      standardWidthPercentage: Number,
      backgroundImageUrl: String,
      gameBackgroundHeight: Number,
      gameBackgroundWidth: Number,
      currentQuestionIndex: Number,
      questions: Array,
      numberIconsUrls: Array,
      flagCoordinates: Array,
      flagIconUrl: String,

    }

    static targets = [ "name", "output", "game", "calculateHeightOf"]

    connect() {

      this.flagIconUrlValue = "https://vegan.ch/wp-content/uploads/VGS_VSG_milestone.png";

      this.flagCoordinatesValue = [
        {
          x: 8,
          y: 82
        },
        {
          x: 21,
          y: 86
        },
        {
          x: 32,
          y: 82
        },
        {
          x: 43,
          y: 74
        },
        {
          x: 55,
          y: 72
        },
        {
          x: 67,
          y: 59
        },
        {
          x: 79,
          y: 76
        },
        {
          x: 91,
          y: 83
        }
      ];

      this.numberIconsUrlsValue = [
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_01.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_02.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_03.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_04.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_05.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_06.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_07.svg",
        "https://vegan.ch/wp-content/uploads/VGS_VSG_frage_08.svg"
      ];

      this.playerIconUrlValue = "https://vegan.ch/wp-content/uploads/VGS_VSG_player.svg";

      this.standardWidthPercentageValue = 95;

      this.backgroundImageUrlValue = "https://vegan.ch/wp-content/uploads/VGS_VSG_bg_kombiniert.svg";

      this.currentQuestionIndexValue = 0;

      this.questionsValue = [
        {
          question: "Du stellst deine Wanderausrüstung zusammen, dabei fragst du dich, welche Marke wohl vegane Wanderschuhe anbietet …",
          solution_index: 1,
          wrong_text: "Bist du dir sicher, dass du für eine Wanderung mit der Veganen Gesellschaft Schweiz gewappnet bist? Auf vegan.ch/blog findest du alle Informationen rund um den veganen Lebensstil.",
          last_question: "false",
          answers: [
            "Sherpa",
            "Lowa",
            "Mammut"
          ]
        },
        {
          question: "Die Wanderausrüstung ist ready, welche Snacks packst du in deinen Rucksack?",
          solution_index: 1,
          wrong_text: "Du schaust dir die Produkte etwas genauer an und merkst Milch Farmer, Hüttenkäse und Bio-Choco Cookies von der Migros sind leider nicht vegan. Und stellst dir vor, wie schön es wäre, wenn es die Bio-Choco Cookies von V-Love gäbe.",
          last_question: "false",
          answers: [
            "Milch Farmer, Brot, Hüttenkäse und Cherrytomaten",
            "Hummus, Brot, Blevitas und eine Packung Oreos",
            "Sojaaufstich, Brot, Blevitas, ein veganer Landjäger und die Bio-Choco Cookies von der Migros"
          ]
        },
        {
          question: "Yeah, alles ready, es kann losgehen. Am Bahnhof merkst du, du hast deine Sonnencreme zu Hause vergessen. Zum Glück reicht die Zeit, um eine Neue zu kaufen. Aber sind Sonnencremes immer vegan?",
          solution_index: 1,
          wrong_text: "Du fragst in der Apotheke nach und erfährst, das es wichtig ist, einen Blick auf die Inhaltsstoffe zu werfen, besonders bei der Herstellung von synthetischen Stoffen können nicht-vegane Mittel zum Einsatz kommen. Auch ist es wichtig, auf die Labels: Veganeblume, Leaping Bunny oder PETA cruelty-free zu schauen, damit wirklich kein Tier für dieses Produkt leiden musste.",
          last_question: "false",
          answers: [
            "Na klar, was soll denn daran tierischen Ursprungs sein?",
            "Nein, nicht jede Sonnencreme ist automatisch vegan.",
            "Hää, reicht es nicht wenn ich auf tierische Produkte beim Essen verzichte?"
          ]
        },
        {
          question: "Geschafft auf gehts in die Berge. Das Wetter ist perfekt und die Natur strahlt in schönster Pracht. Du erfährst, dass es viele Pflanzen und Kräuter gibt, die geniessbar sind. Aber welche Pflanze ist den nun essbar?",
          solution_index: 1,
          wrong_text: "Die Sonne, die seit Stunden auf dein Kopf scheint, macht dich langsam, aber sicher etwas schwammig im Schedel. Du siehst all die schönen Pflanzen und hörst nur «essbar» du greifst zu, gönnst dir einen guten Bissen, schluckst in herunter und starrst in schockierte Gesichter. Bevor deine Augen zufallen, siehst du wie in der Ferne ein Rega-Helikopter in euere Richtung fliegt und hoffst, dass sie dich noch rechtzeitig abholen.",
          last_question: "false",
          answers: [
            "Eibe",
            "Rotklee",
            "Bilsenkraut"
          ]
        },
        {
          question: "Eine Handvoll Rotklee packst du für später ein, damit kannst du leckeres Knäckebrot backen, wie dir Erzählt wurde. Ihr geht den Weg weiter und kommt in den Wald, links und rechts vom Pfad seht ihr viele Pilze, die ihren Weg an die Oberfläche gefunden haben. Doch welcher dieser Pilze könntest du essen?",
          solution_index: 0,
          wrong_text: "So schöne Farben hast du selten bei Pilzen gesehen. Von der Sonne schon leicht matsche im Kopf, läufst du schnurstracks auf die bunten Pilze zu, schneidest einen ab und beisst rein. «Hmm.. etwa komisch schmeckt er schon», denkst du dir, schluckst den Mundinhalt dennoch runter und läufst mit dem abgebissenen Pilz zurück zu den anderen. «Hast du nicht zu gehört, dieser Pilz ist giftig!» Du merkst, wie sich alles anfängt zu drehen und kippst im Stehen zusammen.",
          last_question: "false",
          answers: [
            "Kräuterseitling",
            "Fliegenpilz",
            "Grüner Knollenblätterpilz"
          ]
        },
        {
          question: "Uff, bei so vielen neuen Infos knurrt der Magen. Alle packen ihren Proviant aus, ein riesen Buffet. Alle greifen zu und schlagen sich den Bauch voll. Du fragst dich, was Protein enthalten hat.",
          solution_index: 1,
          wrong_text: "Sorry, aber Süssigkeiten und Snacks sind wirklich nicht die beste Wahl, wenn es um Proteinreiches essen geht.",
          last_question: "false",
          answers: [
            "Oreos, Gummibärli und Manner Waffeln",
            "Nüsse, Kichererbsen und Vollkornbrot",
            "Chips, Salzstängeli und Zwieback"
          ]
        },
        {
          question: "Gestärkt gehts weiter, ihr kommt an einem Berg Restaurant vorbei – Zeit für eine Abkühlung. Ihr schaut euch die Glacékarte an. Welches Glacé ist vegan?",
          solution_index: 1,
          wrong_text: "Einen ganzen Tag bist du schon mit der Veganen Gesellschaft Schweiz unterwegs und dennoch hast du nichts gelernt. WASSERGLACÉ greif zum WASSERGLACÉ...",
          last_question: "true",
          answers: [
            "Cournet",
            "Rakete",
            "Maxibon"
          ]
        }
      ];


      this.initiateGame();
    }

    initiateGame(){
      this.setSvg()
      .then(() => this.setFirstBox())
      .then(() => this.setSecondBox())
      .then(() => this.setGameBackground())
      .then(() => this.mainBoxHtml({content: this.startTextValue, imageUrl: this.playerIconUrlValue}))
      .then((main_box_html) => this.fillFirstBox(
      {
        html: main_box_html,
        imageUrl: this.playerIconUrlValue
      }
      ))
      .then(() => this.startButtonHtml())
      .then((start_button_html) => this.fillSecondBox(
      {
        html: start_button_html,
        imageUrl: ""
      }
      ))
      .then(() => this.appendImageToGameBackground())
      .then(() => this.moveGameBackground())
      .then(() => this.setPlayerIcon())
      .then(() => this.appendPlayerIconToGameBackground());
    }

    //svg setters
    setSvg(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.widthValue = self.gameTarget.offsetWidth;

        svg = d3.select("#game")
          .append("svg")
          .attr("width", self.widthValue)
          .attr("height", 1800)
          .append("g")
          .attr("transform", `translate(${0}, ${0})`);

          final_resolve(svg);

      })
    }

    setFirstBox(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        firstBox = svg.append("g");

        final_resolve(firstBox);

      })
    }

    setSecondBox(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        secondBox = svg.append("g");

        final_resolve(secondBox);

      })
    }

    setGameBackground(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        gameBackground = svg.append("g");

        final_resolve(gameBackground);

      })
    }

    setFlags(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        flags = gameBackground.append("g");

        final_resolve(gameBackground);

      })
    }

    setPlayerIcon(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        playerIcon = gameBackground.append("g")
        .attr("transform", `translate(${self.gameBackgroundWidthValue/2}, ${50})`)
        .style("opacity", 0);

        final_resolve(playerIcon);

      })
    }

    appendImageToGameBackground(){

      var self = this;

      return new Promise(function(final_resolve, final_reject){
        self.gameBackgroundWidthValue = (self.widthValue/100) * self.standardWidthPercentageValue;

        self.gameBackgroundHeightValue = self.gameBackgroundWidthValue * 0.56585754078;

        gameBackground.append("svg:image")
          //.attr("transform", `translate(${0}, ${self.firstBoxValue.height + self.secondBoxValue.height})`)
          .attr('width', self.gameBackgroundWidthValue)
          .attr('id', "survival_game_background_image")
          .attr('height', self.gameBackgroundHeightValue)
          .style("opacity", 1)
          .attr("xlink:href", "https://vegan.ch/wp-content/uploads/VGS_VSG_bg_kombiniert.svg");

          final_resolve(gameBackground);

      })

    }

    appendPlayerIconToGameBackground(){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        playerIcon
        .append("svg:image")
        //.attr("transform", `translate(${0}, ${0})`)
        //.attr('x', (self.widthValue / 100) * self.flagCoordinatesValue[0].x + 12)
        //.attr('y', (self.heightValue/100) * self.flagCoordinatesValue[0].y + 100)
        .attr('width', (self.widthValue / 100) * 8)
        //.attr('height', this.heightValue)
        .style("cursor", "pointer")
        .attr("xlink:href", self.playerIconUrlValue);

        final_resolve(playerIcon);
      })
    }

    makePlayerIconVisible(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){
        console.log("makePlayerIconVisible");
        playerIcon
        .transition()
        .duration(1000)
        .style("opacity", 1)
        .on("end", function(){
          final_resolve(playerIcon);
        });
      })
    }

    movePlayerIcon(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){


        playerIcon
        .transition()
        .duration(1500)
        .attr("transform", `translate(${(self.gameBackgroundWidthValue / 100) * self.flagCoordinatesValue[self.currentQuestionIndexValue].x}, ${(self.gameBackgroundHeightValue / 100) * self.flagCoordinatesValue[self.currentQuestionIndexValue].y})`)
        .on("end", final_resolve(playerIcon));

        //.attr("transform", `translate(${(self.widthValue / 100) * self.flagCoordinatesValue[self.currentQuestionIndexValue].x}, ${(self.backgroundImageHeightValue/ 100) * self.flagCoordinatesValue[self.currentQuestionIndexValue].y})`);

      })
    }

    appendFlagsToGameBackground(){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        for (let i = 0; i < self.flagCoordinatesValue.length; i++) {

        var flagWidth = (self.gameBackgroundWidthValue / 100) * 8;
        var flagHeight = flagWidth;

        setTimeout(() => {

          var single_flag = flags
              .append('g')
              .attr("transform", `translate(${(self.gameBackgroundWidthValue / 100) * self.flagCoordinatesValue[i].x}, ${(self.gameBackgroundHeightValue / 100) * self.flagCoordinatesValue[i].y})`)
              //.attr("transform", `translate(${(self.gameBackgroundWidthValue / 100) * self.flagCoordinatesValue[i].x}, ${(self.gameBackgroundHeightValue / 100) * self.flagCoordinatesValue[i].y})`)
              .append("svg:image")
              .attr("transform", `translate(${-(flagWidth * 0.48)}, ${-flagHeight * 0.73})`)
              //.attr('x', (self.widthValue / 100) * self.flagCoordinatesValue[0].x + 12)
              //.attr('y', (self.heightValue/100) * self.flagCoordinatesValue[0].y + 100)
              .attr('width', flagWidth)
              .attr('height', flagHeight)
              //.attr('height', this.heightValue)
              .style("cursor", "pointer")
              .style("opacity", 0)
              .attr("xlink:href", self.flagIconUrlValue);

          single_flag
          .transition()
          .duration(1000)
          .style("opacity", 1)

          }, i * 100);



        }

          final_resolve(flags);

      })

    }

    moveGameBackground(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){
        gameBackground
        .transition()
        .duration(1000)
        .attr("transform", `translate(${0}, ${self.firstBoxValue.height + self.secondBoxValue.height})`);

        final_resolve(gameBackground);
      })

    }


    startGame(){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.makePlayerIconVisible()
        .then(() => self.setFlags())
        .then(() => self.appendFlagsToGameBackground())
        .then(() => self.goToNextQuestion())
        .then(() => final_resolve(""));

      })
    }

    goToNextQuestion(){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.mainBoxHtml({content: self.questionsValue[self.currentQuestionIndexValue].question, imageUrl: self.numberIconsUrlsValue[self.currentQuestionIndexValue]})
        .then((main_box_html) =>self.fillFirstBox(
        {
          html: main_box_html,
          imageUrl: self.playerIconUrlValue
        }
        ))
        .then(() => self.answersHtml())
        .then((answers_html) => self.fillSecondBox(
        {
          html: answers_html,
          imageUrl: ""
        }
        ))
        .then(() => self.moveGameBackground())
        .then(() => self.movePlayerIcon())
        .then(() => final_resolve(""))
      })
    }


    //svg fillers
    fillFirstBox(parameters){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.boxDataGatherer(parameters)
        .then((data) => {

          self.firstBoxValue = {
            html: data.html,
            height: data.height,
            imageUrl: data.imageUrl
          }

          d3.selectAll(firstBox._groups[0][0].childNodes).remove();

          firstBox.append("foreignObject")
          //firstBox is at the top
          .attr('x', 0)
          .attr('y', 0)
          .attr('width', (self.widthValue/100) * self.standardWidthPercentageValue)
          .attr('height', data.height)
          .append("xhtml:div")
          .html(data.html);

          final_resolve(firstBox);

        });

      })
    }

    fillSecondBox(parameters){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.boxDataGatherer(parameters)
        .then((data) => {

          d3.selectAll(secondBox._groups[0][0].childNodes).remove();


          self.secondBoxValue = {
            html: data.html,
            height: data.height,
            imageUrl: data.imageUrl
          }

          secondBox.append("foreignObject")
          .attr('x', 0)
          .attr('y', self.firstBoxValue.height)
          .attr('width', (self.widthValue/100) * self.standardWidthPercentageValue)
          .attr('height', data.height)
          .append("xhtml:div")
          .html(data.html);

          final_resolve(secondBox);

        });

      })
    }

    checkAnswer(event){

      if(this.questionsValue[this.currentQuestionIndexValue].solution_index == event.params.index){
        if(this.questionsValue[this.currentQuestionIndexValue].last_question == "true"){
          console.log("last");

          this.currentQuestionIndexValue = this.currentQuestionIndexValue + 1;

        } else {
          this.currentQuestionIndexValue = this.currentQuestionIndexValue + 1;
          this.goToNextQuestion()
        }

      } else {
        console.log("death");
      }
    }




    //helpers
    boxDataGatherer(parameters){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.calculateHeightOf(parameters.html)
        .then((calculated_height) => {
              final_resolve({height: calculated_height, html: parameters.html})
        })


      })

    }

    calculateHeightOf(html){

      var self = this;

      return new Promise(function(final_resolve, final_reject){

        self.calculateHeightOfTarget.innerHTML = html;
        self.calculateHeightOfTarget.style.width = self.standardWidthPercentageValue + "%";

        setTimeout(() => {
            //final_resolve(self.calculateHeightOfTarget.getBoundingClientRect().height)
            final_resolve(self.calculateHeightOfTarget.offsetHeight + 25)
          }, 100);

      })
    }

    //html-getters
    mainBoxHtml(parameters){
      var self = this;

      return new Promise(function(final_resolve, final_reject){
        var html = `
        <div class="card text-white py-2" style="background-color: #415C66;">
          <div class="row g-0">
            <div class="col-md-2 text-center">
              <img src="${parameters["imageUrl"]}" class="img-fluid rounded-start" style="max-height: 100px;">
            </div>
            <div class="col-md-10">
              <div class="card-body">
                ${parameters.content}
              </div>
            </div>
          </div>
        </div>
        `;

        final_resolve(html);
      })

    }

    startButtonHtml(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){
        var html = `
        <div class="p-4" style="background-color: #FFFFFF; border-radius: 50px; cursor: pointer" data-action="click->survival-game#startGame">
          <table>
            <tr>
              <td style="width: 35px;">
                <div style="border-radius: 50%;
                height: 25px;
                width: 25px;
                background: transparent;
                border: 2px solid #63C3D1;">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                </div>
              </td>
              <td style="padding-left: 15px;">Spiel starten</td>
            </tr>
          </table>
        </div>
        `;

        final_resolve(html);
      })

    }

    answersHtml(){
      var self = this;

      return new Promise(function(final_resolve, final_reject){

        var answers_string = "";

        for (let i = 0; i < self.questionsValue[self.currentQuestionIndexValue].answers.length; i++) {
          answers_string +=
          `
          <div class="p-2 mb-2" style="background-color: #FFFFFF; border-radius: 50px; cursor: pointer" data-action="click->survival-game#checkAnswer" data-survival-game-index-param="${i}">
            <table>
              <tr>
                <td style="width: 35px; background: transparent; vertical-align: center !important;">
                  <div style="padding-left:5px;
                  border-radius: 50%;
                  height: 25px;
                  width: 25px;
                  background: transparent;
                  border: 2px solid #63C3D1;">
                  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                  </div>
                </td>
                <td style="padding-left: 15px;">${self.questionsValue[self.currentQuestionIndexValue].answers[i]}</td>
              </tr>
            </table>
          </div>
          `;
        }

        final_resolve(answers_string);

      })
    }


  })
</script>

  <div data-controller="survival-game"
    data-survival-game-margin-value="{}"
    data-survival-game-start-text-value="<p><strong>Hey du, heute gehen wir gemeinsam Wandern.</strong></p> <p>Da du heute mit der Veganen Gesellschaft Schweiz unterwegs bist, stehen rein pflanzliche Lebensmittel auf dem Speiseplan.</p>"
    class="container-fluid" style="background-color: #63C3D1; font-size: 0.9rem;"
  >

    <span data-survival-game-target="output">
    </span>

    <div data-survival-game-target="game" id="game">

    </div>

    <div data-survival-game-target="calculateHeightOf">

    </div>


  </div>
